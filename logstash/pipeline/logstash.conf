input {
  # Logstash bu portu dinler — Spring Boot'un LogstashTcpSocketAppender'ı buraya gönderir
  tcp {
    port => 5044
    codec => json_lines
  }
}

filter {
  # Tarih alanını standart hale getir
  date {
    match => ["@timestamp", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "ISO8601"]
    target => "@timestamp"
  }

  # Uygulama adını etiketle
  if [app] {
    mutate {
      add_tag => ["%{app}"]
    }
  }

  # HTTP durum kodunu tam sayıya çevir (Kibana'da filtreleme için)
  if [statusCode] {
    mutate {
      convert => { "statusCode" => "integer" }
    }
  }

  # durationMs alanını tam sayıya çevir
  if [durationMs] {
    mutate {
      convert => { "durationMs" => "integer" }
    }
  }
}

output {
  # Elasticsearch'e gönder
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    # Index pattern: flight-aggregator-2026.02.22
    index => "flight-aggregator-%{+YYYY.MM.dd}"
    # Otomatik index oluşturma (ILM ile yönet — prod'da)
  }

  # Debug: Konsola da yaz (test sırasında görünürlük için, prod'da kaldırılabilir)
  stdout { codec => rubydebug }
}
